From 3fda8cc63f18d3fbe02ffcf1ca75efce2cfeb672 Mon Sep 17 00:00:00 2001
From: David Arcari <darcari@redhat.com>
Date: Fri, 14 Oct 2016 17:09:53 -0400
Subject: [hid] i2c-hid: exit if the IRQ is not valid

Message-id: <1476464993-15836-1-git-send-email-darcari@redhat.com>
Patchwork-id: 158880
O-Subject: [RHEL7.4 PATCH BZ 1376599] HID: i2c-hid: exit if the IRQ is not valid
Bugzilla: 1376599
Z-Bugzilla: 1393717
RH-Acked-by: Jerry Snitselaar <jsnitsel@redhat.com>
RH-Acked-by: Steve Best <sbest@redhat.com>
RH-Acked-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>

Description:
--------------
The touchpad on HP Zbook 15 Studio mWS does not work in RHEL7.3 as an invalid
irq is passed into i2c-hid.  This fix avoids that problem by immediately
returning an error allowing the system to access the touchpad via the PS/2 node.
--------------

Bugzilla: http://bugzilla.redhat.com/1376599
Brew: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=11909672
Upstream: https://git.kernel.org/cgit/linux/kernel/git/jikos/hid.git/commit/?h=for-4.10/i2c-hid&id=93d26aeab54cc91119760bc4f1f22bff9a987d70

Test Result:
--------------
Used the brew build to verify the fix on the laptop that exhibited the issue.
With the patch applied, the laptop has a functional touchpad.  The expected
error was recorded in the log:

[    8.954116] i2c_hid 15-002c: HID over i2c doesn't have a valid IRQ
--------------

commit 93d26aeab54cc91119760bc4f1f22bff9a987d70
Author: David Arcari <darcari@redhat.com>
Date:   Thu Oct 13 11:30:45 2016 +0200

    HID: i2c-hid: exit if the IRQ is not valid

    When i2c-core doesn't find the IRQ associated to the GPIO because
    the gpiochip is not available, it assigns -EPROBE_DEFER to the irq.
    We need to bail out there and on any other error in an IRQ.

    Signed-off-by: David Arcari <darcari@redhat.com>
    Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
    Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>

Cc: Benjamin Tissoires <benjamin.tissoires@redhat.com>
Cc: David Arcari <darcari@redhat.com>
Signed-off-by: Frantisek Hrbata <fhrbata@hrbata.com>

diff --git a/drivers/hid/i2c-hid/i2c-hid.c b/drivers/hid/i2c-hid/i2c-hid.c
index 2e1e9b9..e6abd74 100644
--- a/drivers/hid/i2c-hid/i2c-hid.c
+++ b/drivers/hid/i2c-hid/i2c-hid.c
@@ -946,6 +946,13 @@ static int i2c_hid_probe(struct i2c_client *client,
   return -EINVAL;
  }
 
+ if (client->irq < 0) {
+  if (client->irq != -EPROBE_DEFER)
+   dev_err(&client->dev,
+    "HID over i2c doesn't have a valid IRQ\n");
+  return client->irq;
+ }
+
  ihid = kzalloc(sizeof(struct i2c_hid), GFP_KERNEL);
  if (!ihid)
   return -ENOMEM;
-- 
1.7.1