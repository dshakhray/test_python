From be125de4d8bcb1f735d594ec57f5a9dc6cfe053d Mon Sep 17 00:00:00 2001
From: Tomas Henzl <thenzl@redhat.com>
Date: Thu, 17 Nov 2016 16:08:31 -0500
Subject: [scsi] megaraid_sas: Fix data integrity failure for JBOD (passthrough) devices

Message-id: <1479398917-6631-8-git-send-email-thenzl@redhat.com>
Patchwork-id: 160592
O-Subject: [RHEL7.4 e-stor PATCH 07/13] scsi: megaraid_sas: Fix data integrity failure for JBOD (passthrough) devices
Bugzilla: 1380447
Z-Bugzilla: 1398179
RH-Acked-by: Maurizio Lombardi <mlombard@redhat.com>
RH-Acked-by: Jarod Wilson <jarod@redhat.com>

Commit 02b01e010afe ("megaraid_sas: return sync cache call with
success") modified the driver to successfully complete SYNCHRONIZE_CACHE
commands without passing them to the controller. Disk drive caches are
only explicitly managed by controller firmware when operating in RAID
mode. So this commit effectively disabled writeback cache flushing for
any drives used in JBOD mode, leading to data integrity failures.

[mkp: clarified patch description]

Fixes: 02b01e010afeeb49328d35650d70721d2ca3fd59
CC: stable@vger.kernel.org
Signed-off-by: Kashyap Desai <kashyap.desai@broadcom.com>
Signed-off-by: Sumit Saxena <sumit.saxena@broadcom.com>
Reviewed-by: Tomas Henzl <thenzl@redhat.com>
Reviewed-by: Hannes Reinecke <hare@suse.com>
Reviewed-by: Ewan D. Milne <emilne@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 1e793f6fc0db920400574211c48f9157a37e3945)
Signed-off-by: Frantisek Hrbata <fhrbata@hrbata.com>

diff --git a/drivers/scsi/megaraid/megaraid_sas_base.c b/drivers/scsi/megaraid/megaraid_sas_base.c
index d0260ab..bbbd0d8 100644
--- a/drivers/scsi/megaraid/megaraid_sas_base.c
+++ b/drivers/scsi/megaraid/megaraid_sas_base.c
@@ -1713,16 +1713,13 @@ megasas_queue_command(struct Scsi_Host *shost, struct scsi_cmnd *scmd)
   goto out_done;
  }
 
- switch (scmd->cmnd[0]) {
- case SYNCHRONIZE_CACHE:
-  /*
-   * FW takes care of flush cache on its own
-   * No need to send it down
-   */
+ /*
+  * FW takes care of flush cache on its own for Virtual Disk.
+  * No need to send it down for VD. For JBOD send SYNCHRONIZE_CACHE to FW.
+  */
+ if ((scmd->cmnd[0] == SYNCHRONIZE_CACHE) && MEGASAS_IS_LOGICAL(scmd)) {
   scmd->result = DID_OK << 16;
   goto out_done;
- default:
-  break;
  }
 
  return instance->instancet->build_and_issue_cmd(instance, scmd);
-- 
1.7.1