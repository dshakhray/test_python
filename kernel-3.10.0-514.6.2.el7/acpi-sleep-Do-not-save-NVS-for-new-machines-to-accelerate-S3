From 7f5fb51a68e317bd01b5ef6b3e5ce1395fe9a44b Mon Sep 17 00:00:00 2001
From: Prarit Bhargava <prarit@redhat.com>
Date: Wed, 16 Nov 2016 16:07:23 -0500
Subject: [acpi] sleep: Do not save NVS for new machines to accelerate S3

Message-id: <1479312443-5381-1-git-send-email-prarit@redhat.com>
Patchwork-id: 160571
O-Subject: [RHEL7.4 PATCH BZ 1385527] ACPI / sleep: Do not save NVS for new machines to accelerate S3
Bugzilla: 1385527
Z-Bugzilla: 1402326
RH-Acked-by: Jeremy McNicoll <jmcnicol@redhat.com>
RH-Acked-by: David Arcari <darcari@redhat.com>
RH-Acked-by: Jarod Wilson <jarod@redhat.com>

Bugzilla: http://bugzilla.redhat.com/1385527

Build info:
Date: Wed Nov 16 11:01:39 EST 2016
Build OS: Red Hat Enterprise Linux Server release 7.3 (Maipo)
System name: hp-z820-01.khw.lab.eng.bos.redhat.com with -j24
Built on: kernel-3.10.0-520.el7
Arch built: ppc64 s390x x86_64

commit 821d6f0359b0614792ab8e2fb93b503e25a65079
Author: Lan Tianyu <tianyu.lan@intel.com>
Date:   Wed Jul 23 14:42:33 2014 +0800

    ACPI / sleep: Do not save NVS for new machines to accelerate S3

    NVS region is saved and restored unconditionally for machines without
    nvs_nosave quirk during S3. Tested some new machines and the operation
    is not necessary. Saving NVS region also affects S2RAM speed. The time of
    NVS saving and restoring depends on the size of NVS region and it consumes
    7~10ms normally.

    This patch is to make machines produced from 2012 to now not saving NVS region
    to accelerate S3.

    Signed-off-by: Lan Tianyu <tianyu.lan@intel.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>

This seems to resolve the S3 suspend/resume, however, it also uncovered a bug in
the DELL (Intel?) BIOS.  See
https://bugzilla.redhat.com/show_bug.cgi?id=1385527#c24 for details.

Cc: Lenny Szubowicz <lszubowi@redhat.com>
Signed-off-by: Frantisek Hrbata <fhrbata@hrbata.com>

diff --git a/drivers/acpi/sleep.c b/drivers/acpi/sleep.c
index 2432b9e..59b7e45 100644
--- a/drivers/acpi/sleep.c
+++ b/drivers/acpi/sleep.c
@@ -314,6 +314,11 @@ static struct dmi_system_id __initdata acpisleep_dmi_table[] = {
 
 static void acpi_sleep_dmi_check(void)
 {
+ int year;
+
+ if (dmi_get_date(DMI_BIOS_DATE, &year, NULL, NULL) && year >= 2012)
+  acpi_nvs_nosave_s3();
+
  dmi_check_system(acpisleep_dmi_table);
 }
 
-- 
1.7.1