From a6c3c6a987c49add4c1ff7734db1c3f869427def Mon Sep 17 00:00:00 2001
From: Marcelo Tosatti <mtosatti@redhat.com>
Date: Sun, 30 Oct 2016 23:46:33 -0400
Subject: [x86] kvm: x86: move nsec_to_cycles from x86.c to x86.h

Message-id: <20161030234823.586332947@redhat.com>
Patchwork-id: 160151
O-Subject: [RHEL7.4 PATCH BZ1389431 1/2] KVM: x86: move nsec_to_cycles from x86.c to x86.h
Bugzilla: 1389431
Z-Bugzilla: 1391614
RH-Acked-by: Bandan Das <bsd@redhat.com>
RH-Acked-by: Paolo Bonzini <pbonzini@redhat.com>
RH-Acked-by: Andrew Jones <drjones@redhat.com>

upstream commit 8d93c874ac899bfdf0ad3787baef684a0c878c2c

Move the inline function nsec_to_cycles from x86.c to x86.h, as
the next patch uses it from lapic.c.

Signed-off-by: Marcelo Tosatti <mtosatti@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
BZ: 1389431
Brew: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=11976826
Signed-off-by: Frantisek Hrbata <fhrbata@hrbata.com>

diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index 6036ab4..c705563 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -1225,12 +1225,6 @@ static atomic_t kvm_guest_has_master_clock = ATOMIC_INIT(0);
 static DEFINE_PER_CPU(unsigned long, cpu_tsc_khz);
 static unsigned long max_tsc_khz;
 
-static inline u64 nsec_to_cycles(struct kvm_vcpu *vcpu, u64 nsec)
-{
- return pvclock_scale_delta(nsec, vcpu->arch.virtual_tsc_mult,
-       vcpu->arch.virtual_tsc_shift);
-}
-
 static u32 adjust_tsc_khz(u32 khz, s32 ppm)
 {
  u64 v = (u64)khz * (1000000 + ppm);
diff --git a/arch/x86/kvm/x86.h b/arch/x86/kvm/x86.h
index c4ca247..af0b9cd 100644
--- a/arch/x86/kvm/x86.h
+++ b/arch/x86/kvm/x86.h
@@ -2,6 +2,7 @@
 #define ARCH_X86_KVM_X86_H
 
 #include <linux/kvm_host.h>
+#include <asm/pvclock.h>
 #include "kvm_cache_regs.h"
 
 #define MSR_IA32_CR_PAT_DEFAULT  0x0007040600070406ULL
@@ -187,4 +188,11 @@ extern unsigned int min_timer_period_us;
 extern unsigned int lapic_timer_advance_ns;
 
 extern struct static_key kvm_no_apic_vcpu;
+
+static inline u64 nsec_to_cycles(struct kvm_vcpu *vcpu, u64 nsec)
+{
+ return pvclock_scale_delta(nsec, vcpu->arch.virtual_tsc_mult,
+  vcpu->arch.virtual_tsc_shift);
+}
+
 #endif
-- 
1.7.1