From 3103f7aeb77dd33b0b2c892a5d93e4c8057293bd Mon Sep 17 00:00:00 2001
From: Linda Knippers <lknipper@redhat.com>
Date: Fri, 28 Oct 2016 17:18:55 -0400
Subject: [watchdog] hpwdt: add support for iLO5

Message-id: <1477675135-12321-1-git-send-email-lknipper@redhat.com>
Patchwork-id: 160121
O-Subject: [RHEL7.4 BZ 1382798 PATCH] watchdog: hpwdt: add support for iLO5
Bugzilla: 1382798
Z-Bugzilla: 1397747
RH-Acked-by: Dean Nelson <dnelson@redhat.com>
RH-Acked-by: David Arcari <darcari@redhat.com>
RH-Acked-by: Jarod Wilson <jarod@redhat.com>
RH-Acked-by: Steve Best <sbest@redhat.com>

Bugzilla:  https://bugzilla.redhat.com/show_bug.cgi?id=1382798
Brew: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=11960875
Testing:  Tested on a Gen10 prototype and confirmed that without this
patch, no iLO was detected. With the patch, the iLO is detected
and /dev/watchdog is created.  Also sanity tested on a Gen9.

upstream commit:  fc113d54e9d7ef3296cdf2eff49c8ca0a3e5a482

  iLO5 will offer the same watchdog timer as previous generations, but the
  PCI subsystem vendor ID will be PCI_VENDOR_ID_HP_3PAR (0x1590) instead of
  PCI_VENDOR_ID_HP (0x103c).  Add 0x1590 to the whitelist and be more
  specific when ignoring the 103c,1979 device.

  Signed-off-by: Brian Boylston <brian.boylston@hpe.com>
  Reviewed-by: Guenter Roeck <linux@roeck-us.net>
  Signed-off-by: Guenter Roeck <linux@roeck-us.net>
  Signed-off-by: Wim Van Sebroeck <wim@iguana.be>

This was not a clean cherry-pick because an earlier commit
of 0821f20d49d19f49e53b05ef6727e010c4b1f11d inserted code
in the wrong place.  This patch touched the same code so I
fixed up the problem by deleting the incorrectly inserted
code from the previous commit.

Signed-off-by: Linda Knippers <lknipper@redhat.com>
Signed-off-by: Frantisek Hrbata <fhrbata@hrbata.com>

diff --git a/drivers/watchdog/hpwdt.c b/drivers/watchdog/hpwdt.c
index e633dd4..9be77cb 100644
--- a/drivers/watchdog/hpwdt.c
+++ b/drivers/watchdog/hpwdt.c
@@ -39,7 +39,7 @@
 #endif /* CONFIG_HPWDT_NMI_DECODING */
 #include <asm/nmi.h>
 
-#define HPWDT_VERSION   "1.3.3"
+#define HPWDT_VERSION   "1.4.0"
 #define SECS_TO_TICKS(secs)  ((secs) * 1000 / 128)
 #define TICKS_TO_SECS(ticks)  ((ticks) * 128 / 1000)
 #define HPWDT_MAX_TIMER   TICKS_TO_SECS(65535)
@@ -804,13 +804,6 @@ static int hpwdt_init_one(struct pci_dev *dev,
 {
  int retval;
 
-
- /*
-  * Ignore all auxilary iLO devices with the following PCI ID
-  */
- if (dev->subsystem_device == 0x1979)
-  return -ENODEV;
-
  /*
   * Check if we can do NMI decoding or not
   */
@@ -821,12 +814,20 @@ static int hpwdt_init_one(struct pci_dev *dev,
   * not run on a legacy ASM box.
   * So we only support the G5 ProLiant servers and higher.
   */
- if (dev->subsystem_vendor != PCI_VENDOR_ID_HP) {
+ if (dev->subsystem_vendor != PCI_VENDOR_ID_HP &&
+     dev->subsystem_vendor != PCI_VENDOR_ID_HP_3PAR) {
   dev_warn(&dev->dev,
    "This server does not have an iLO2+ ASIC.\n");
   return -ENODEV;
  }
 
+ /*
+  * Ignore all auxilary iLO devices with the following PCI ID
+  */
+ if (dev->subsystem_vendor == PCI_VENDOR_ID_HP &&
+     dev->subsystem_device == 0x1979)
+  return -ENODEV;
+
  if (pci_enable_device(dev)) {
   dev_warn(&dev->dev,
    "Not possible to enable PCI Device: 0x%x:0x%x.\n",
-- 
1.7.1