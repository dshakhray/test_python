From a8c8fcc4769544bca2f188ffe8d7aeae1c10c701 Mon Sep 17 00:00:00 2001
From: Laurent Vivier <lvivier@redhat.com>
Date: Wed, 21 Oct 2015 07:50:16 +0200
Subject: [powerpc] pci: initialize hybrid_dma_data before use

Message-id: <1445413816-13070-1-git-send-email-lvivier@redhat.com>
Patchwork-id: 125826
O-Subject: [RHEL7.3 kernel PATCH v2] Downstream-only powerpc: initialize hybrid_dma_data before use.
Bugzilla: 1270717
Z-Bugzilla: 1279793
RH-Acked-by: David Gibson <dgibson@redhat.com>
RH-Acked-by: Bandan Das <bsd@redhat.com>
RH-Acked-by: Thomas Huth <thuth@redhat.com>

BREW: https://brewweb.devel.redhat.com/taskinfo?taskID=9984768
BZ: https://bugzilla.redhat.com/show_bug.cgi?id=1270717
Upstream Status: Downstream only

"Downstream only" because the problem has been introduced by
the changes needed to manage RH kABI:

commit 51e9486 [powerpc] iommu: Remove dma_data union
for "BZ1246880 RHEL7.1 - DDW not working with mpt2sas driver on POWER"

pci_device_add() calls pcibios_setup_device() which is trying to
set dma offset. To not break kABI, dma_data has been replaced by
a pointer stored in hybrid_dma_data. This pointer is initialized
in arch_dma_init().

arch_dma_init() is called by vio_register_device_node(), but not
by pci_device_add(). And as set_dma_offset() uses it without
checking its validity, we have an invalid memory access when hotplugging
a PCI card.

This patch calls arch_dma_init() from pcibios_setup_device()
to initialize hybrid_dma_data before use.

Signed-off-by: Laurent Vivier <lvivier@redhat.com>
Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/arch/powerpc/kernel/pci-common.c b/arch/powerpc/kernel/pci-common.c
index 6ee4540..5003ea6 100644
--- a/arch/powerpc/kernel/pci-common.c
+++ b/arch/powerpc/kernel/pci-common.c
@@ -987,6 +987,8 @@ void pcibios_setup_bus_self(struct pci_bus *bus)
 
 static void pcibios_setup_device(struct pci_dev *dev)
 {
+ arch_dma_init(&dev->dev);
+
  /* Fixup NUMA node as it may not be setup yet by the generic
   * code and is needed by the DMA init
   */
-- 
1.7.1