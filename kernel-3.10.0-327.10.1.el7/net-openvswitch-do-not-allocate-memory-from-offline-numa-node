From 5068e7bbd8805a25d44a73f0283ccdb112a16a52 Mon Sep 17 00:00:00 2001
From: Thadeu Lima de Souza Cascardo <cascardo@redhat.com>
Date: Tue, 5 Jan 2016 17:40:26 +0100
Subject: [net] openvswitch: do not allocate memory from offline numa node

Message-id: <1452015626-10013-1-git-send-email-cascardo@redhat.com>
Patchwork-id: 131663
O-Subject: [RHEL7.3 net PATCH] ovs: do not allocate memory from offline numa node
Bugzilla: 1294398
Z-Bugzilla: 1300614
RH-Acked-by: Jarod Wilson <jarod@redhat.com>
RH-Acked-by: Paolo Abeni <pabeni@redhat.com>
RH-Acked-by: Aaron Conole <aconole@redhat.com>

From: Konstantin Khlebnikov <khlebnikov@yandex-team.ru>

Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1294398
Brew: https://brewweb.devel.redhat.com/taskinfo?taskID=10277115

Tested on a patched qemu with a memoryless node 0.

    commit 598c12d0ba6de9060f04999746eb1e015774044b
    Author: Konstantin Khlebnikov <khlebnikov@yandex-team.ru>
    Date:   Fri Oct 2 13:18:22 2015 +0300

        ovs: do not allocate memory from offline numa node

        When openvswitch tries allocate memory from offline numa node 0:
        stats = kmem_cache_alloc_node(flow_stats_cache, GFP_KERNEL | __GFP_ZERO, 0)
        It catches VM_BUG_ON(nid < 0 || nid >= MAX_NUMNODES || !node_online(nid))
        [ replaced with VM_WARN_ON(!node_online(nid)) recently ] in linux/gfp.h
        This patch disables numa affinity in this case.

        Signed-off-by: Konstantin Khlebnikov <khlebnikov@yandex-team.ru>
        Acked-by: Pravin B Shelar <pshelar@nicira.com>
        Signed-off-by: David S. Miller <davem@davemloft.net>

Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@redhat.com>
Signed-off-by: Jiri Benc <jbenc@redhat.com>
Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/net/openvswitch/flow_table.c b/net/openvswitch/flow_table.c
index 4613df8..af5fc8e 100644
--- a/net/openvswitch/flow_table.c
+++ b/net/openvswitch/flow_table.c
@@ -91,7 +91,8 @@ struct sw_flow *ovs_flow_alloc(void)
 
  /* Initialize the default stat node. */
  stats = kmem_cache_alloc_node(flow_stats_cache,
-          GFP_KERNEL | __GFP_ZERO, 0);
+          GFP_KERNEL | __GFP_ZERO,
+          node_online(0) ? 0 : NUMA_NO_NODE);
  if (!stats)
   goto err;
 
-- 
1.7.1