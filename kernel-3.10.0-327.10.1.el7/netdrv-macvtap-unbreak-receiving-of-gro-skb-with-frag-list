From 853a457151ff0f9aa389fa00b23388e4ffa14706 Mon Sep 17 00:00:00 2001
From: Jason Wang <jasowang@redhat.com>
Date: Mon, 26 Oct 2015 05:43:09 +0100
Subject: [netdrv] macvtap: unbreak receiving of gro skb with frag list

Message-id: <1445838189-8665-1-git-send-email-jasowang@redhat.com>
Patchwork-id: 125897
O-Subject: [RHEL7.2 PATCH] macvtap: unbreak receiving of gro skb with frag list
Bugzilla: 1273737
Z-Bugzilla: 1279794
RH-Acked-by: Michael S. Tsirkin <mst@redhat.com>
RH-Acked-by: Jarod Wilson <jarod@redhat.com>
RH-Acked-by: Vlad Yasevich <vyasevic@redhat.com>

Bugzilla: 1273737
Brew Build: https://brewweb.devel.redhat.com/taskinfo?taskID=10012581
Test status: Tested by myself.

We don't have fraglist support in TAP_FEATURES. This will lead
software segmentation of gro skb with frag list. Fixes by having
frag list support in TAP_FEATURES.

With this patch single session of netperf receiving were restored from
about 5Gb/s to about 12Gb/s on mlx4.

Fixes a567dd6252 ("macvtap: simplify usage of tap_features")
Cc: Vlad Yasevich <vyasevic@redhat.com>
Cc: Michael S. Tsirkin <mst@redhat.com>
Signed-off-by: Jason Wang <jasowang@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit f23d538bc24a83c16127c2eb82c9cf1adc2b5149
 from net.git)

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/drivers/net/macvtap.c b/drivers/net/macvtap.c
index 10b14d1..d589b6d 100644
--- a/drivers/net/macvtap.c
+++ b/drivers/net/macvtap.c
@@ -137,7 +137,7 @@ static const struct proto_ops macvtap_socket_ops;
 #define TUN_OFFLOADS (NETIF_F_HW_CSUM | NETIF_F_TSO_ECN | NETIF_F_TSO | \
         NETIF_F_TSO6 | NETIF_F_UFO)
 #define RX_OFFLOADS (NETIF_F_GRO | NETIF_F_LRO)
-#define TAP_FEATURES (NETIF_F_GSO | NETIF_F_SG)
+#define TAP_FEATURES (NETIF_F_GSO | NETIF_F_SG | NETIF_F_FRAGLIST)
 
 static struct macvlan_dev *macvtap_get_vlan_rcu(const struct net_device *dev)
 {
-- 
1.7.1