From d457059b180e6b6b20ff7b49af8dff4917992df9 Mon Sep 17 00:00:00 2001
From: Jamie Bainbridge <jbainbri@redhat.com>
Date: Tue, 3 Nov 2015 07:00:03 +0100
Subject: [net] sctp: Fix race between OOTB responce and route removal

Message-id: <6d0a9b5f63878ee764980617cfda349f86f7b251.1446533701.git.jbainbri@redhat.com>
Patchwork-id: 126171
O-Subject: [RHEL 7.3 PATCH] [net] sctp: Fix race between OOTB responce and route removal
Bugzilla: 1277309
Z-Bugzilla: 1281426
RH-Acked-by: Sabrina Dubroca <sdubroca@redhat.com>
RH-Acked-by: Xin Long <lxin@redhat.com>
RH-Acked-by: David S. Miller <davem@redhat.com>
RH-Acked-by: Marcelo Leitner <mleitner@redhat.com>

Backport of upstream 29c4afc

BZ: https://bugzilla.redhat.com/show_bug.cgi?id=1277309
Brew: http://brewweb.devel.redhat.com/brew/taskinfo?taskID=10051989
Tested by: jbainbri and customer

Commit: 29c4afc4e98f4dc0ea9df22c631841f9c220b944
Author: Alexander Sverdlin <alexander.sverdlin@nokia.com>
Date:   2015-06-29 08:41:03 (GMT)

        There is NULL pointer dereference possible during statistics update if
        the route used for OOTB responce is removed at unfortunate time. If the
        route exists when we receive OOTB packet and we finally jump into
        sctp_packet_transmit() to send ABORT, but in the meantime route is
        removed under our feet, we take "no_route" path and try to update stats
        with IP_INC_STATS(sock_net(asoc->base.sk), ...).

        But sctp_ootb_pkt_new() used to prepare responce packet doesn't call
        sctp_transport_set_owner() and therefore there is no asoc associated
        with this packet. Probably temporary asoc just for OOTB responces is
        overkill, so just introduce a check like in all other places in
        sctp_packet_transmit(), where "asoc" is dereferenced.

        Signed-off-by: Alexander Sverdlin <alexander.sverdlin@nokia.com>
        Acked-by: Neil Horman <nhorman@tuxdriver.com>
        Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
        Acked-by: Vlad Yasevich <vyasevich@gmail.com>
        Signed-off-by: David S. Miller <davem@davemloft.net>

Signed-off-by: Jamie Bainbridge <jbainbri@redhat.com>
Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/net/sctp/output.c b/net/sctp/output.c
index 3051f48..7bfafc2 100644
--- a/net/sctp/output.c
+++ b/net/sctp/output.c
@@ -611,7 +611,9 @@ out:
  return err;
 no_route:
  kfree_skb(nskb);
- IP_INC_STATS_BH(sock_net(asoc->base.sk), IPSTATS_MIB_OUTNOROUTES);
+
+ if (asoc)
+  IP_INC_STATS_BH(sock_net(asoc->base.sk), IPSTATS_MIB_OUTNOROUTES);
 
  /* FIXME: Returning the 'err' will effect all the associations
   * associated with a socket, although only one of the paths of the
-- 
1.7.1