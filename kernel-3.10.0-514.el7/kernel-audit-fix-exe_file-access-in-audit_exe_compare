From 11e52a5f651087fe886cb3c65d8b3de64a47f9d6 Mon Sep 17 00:00:00 2001
From: Richard Guy Briggs <rgb@redhat.com>
Date: Sat, 17 Sep 2016 23:42:19 -0400
Subject: [kernel] audit: fix exe_file access in audit_exe_compare

Message-id: <e67db0d17e33dff5e521c558d18361186609f27f.1473974354.git.rgb@redhat.com>
Patchwork-id: 157922
O-Subject: [RHEL7 PATCH V2 4/4] audit: fix exe_file access in audit_exe_compare
Bugzilla: 1374478
RH-Acked-by: Herton R. Krzesinski <herton@redhat.com>
RH-Acked-by: Eric W. Biederman <ebiederm@redhat.com>
RH-Acked-by: Larry Woodman <lwoodman@redhat.com>
RH-Acked-by: Rafael Aquini <aquini@redhat.com>
RH-Acked-by: Paul Moore <pmoore@redhat.com>

From: Mateusz Guzik <mguzik@redhat.com>

Prior to the change the function would blindly deference mm, exe_file
and exe_file->f_inode, each of which could have been NULL or freed.

Use get_task_exe_file to safely obtain stable exe_file.

Signed-off-by: Mateusz Guzik <mguzik@redhat.com>
Acked-by: Konstantin Khlebnikov <khlebnikov@yandex-team.ru>
Acked-by: Richard Guy Briggs <rgb@redhat.com>
Cc: <stable@vger.kernel.org> # 4.3.x
Signed-off-by: Paul Moore <paul@paul-moore.com>
(cherry picked from commit 5efc244346f9f338765da3d592f7947b0afdc4b5)

Signed-off-by: Richard Guy Briggs <rgb@redhat.com>
Signed-off-by: Rafael Aquini <aquini@redhat.com>

diff --git a/kernel/audit_watch.c b/kernel/audit_watch.c
index 359035c..10638f0 100644
--- a/kernel/audit_watch.c
+++ b/kernel/audit_watch.c
@@ -19,6 +19,7 @@
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 
+#include <linux/file.h>
 #include <linux/kernel.h>
 #include <linux/audit.h>
 #include <linux/kthread.h>
@@ -544,10 +545,11 @@ int audit_exe_compare(struct task_struct *tsk, struct audit_fsnotify_mark *mark)
  unsigned long ino;
  dev_t dev;
 
- rcu_read_lock();
- exe_file = rcu_dereference(tsk->mm->exe_file);
+ exe_file = get_task_exe_file(tsk);
+ if (!exe_file)
+  return 0;
  ino = exe_file->f_inode->i_ino;
  dev = exe_file->f_inode->i_sb->s_dev;
- rcu_read_unlock();
+ fput(exe_file);
  return audit_mark_compare(mark, ino, dev);
 }
-- 
1.7.1