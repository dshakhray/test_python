From c64e3ac6a6c5d0f0302093729225915cb1289301 Mon Sep 17 00:00:00 2001
From: Mike Snitzer <snitzer@redhat.com>
Date: Tue, 11 Oct 2016 19:56:03 -0400
Subject: [md] dm raid: fix compat_features validation

Message-id: <1476215763-32175-1-git-send-email-snitzer@redhat.com>
Patchwork-id: 158756
O-Subject: [RHEL7.3 PATCH] dm raid: fix compat_features validation
Bugzilla: 1383726
RH-Acked-by: Jonathan E Brassow <jbrassow@redhat.com>
RH-Acked-by: Heinz Mauelshagen <heinzm@redhat.com>

BZ: 1383726
Brew: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=11890548

Upstream commit 5c33677c87cbe44ae04df69c4a29c1750a9ec4e5
Author: Andy Whitcroft <apw@canonical.com>
Date:   Tue Oct 11 15:16:57 2016 +0100

    dm raid: fix compat_features validation

    In ecbfb9f118bce4 ("dm raid: add raid level takeover support") a new
    compatible feature flag was added.  Validation for these compat_features
    was added but this only passes for new raid mappings with this feature
    flag.  This causes previously created raid mappings to be failed at
    import.

    Check compat_features for the only valid combination.

    Fixes: ecbfb9f118bce4 ("dm raid: add raid level takeover support")
    Cc: stable@vger.kernel.org # v4.8
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Heinz Mauelshagen <heinzm@redhat.com>
    Signed-off-by: Mike Snitzer <snitzer@redhat.com>

Signed-off-by: Rafael Aquini <aquini@redhat.com>

diff --git a/drivers/md/dm-raid.c b/drivers/md/dm-raid.c
index 21a0c95..f4e8a7d 100644
--- a/drivers/md/dm-raid.c
+++ b/drivers/md/dm-raid.c
@@ -2258,7 +2258,8 @@ static int super_validate(struct raid_set *rs, struct md_rdev *rdev)
  if (!mddev->events && super_init_validation(rs, rdev))
   return -EINVAL;
 
- if (le32_to_cpu(sb->compat_features) != FEATURE_FLAG_SUPPORTS_V190) {
+ if (le32_to_cpu(sb->compat_features) &&
+     le32_to_cpu(sb->compat_features) != FEATURE_FLAG_SUPPORTS_V190) {
   rs->ti->error = "Unable to assemble array: Unknown flag(s) in compatible feature flags";
   return -EINVAL;
  }
-- 
1.7.1