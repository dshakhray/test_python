From cc710f2ec90bf60a711752d195778eb2a8de7168 Mon Sep 17 00:00:00 2001
From: Don Dutile <ddutile@redhat.com>
Date: Mon, 12 Sep 2016 15:26:10 -0400
Subject: [infiniband] ib/mlx5: Fix wrong naming of port_rcv_data counter

Message-id: <1473693970-9275-1-git-send-email-ddutile@redhat.com>
Patchwork-id: 157758
O-Subject: [PATCH RHEL-7.3] IB/mlx5: Fix wrong naming of port_rcv_data counter
Bugzilla: 1374862
RH-Acked-by: Honggang Li <honli@redhat.com>
RH-Acked-by: Jeremy McNicoll <jmcnicol@redhat.com>
RH-Acked-by: Jarod Wilson <jarod@redhat.com>

From: Talat Batheesh <talatb@mellanox.com>

port_xmit_data is written instead of port_rcv_data.

Fixes: 3efd9a11212d ('IB/mlx5: Modify MAD reading counters method to use counter registers')
Signed-off-by: Talat Batheesh <talatb@mellanox.com>
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 00bf534fce23048aa0e6fd8dbceedf097ee65508)

Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1374862
Brew: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=11734325

>From bz:
ConnectX-4/mlx5 driver is not properly updating
/sys/class/infiniband/mlx5_?/ports/?/counters/port_rcv_data
in RHEL 7.3, but works upstream already.

Testing: Verified by RH TAM.
This data is used by customer to diagnose system performance,
and critical for customer to have in 7.3 to enable patch-free
RHEL-7.3 use.

Bug fix specific to mlx5, not RDMA core, and easily tested/verified.
Read: low risk even at this late point in release, and highly
      beneficial to customer.

Signed-off-by: Donald Dutile <ddutile@redhat.com>
Signed-off-by: Rafael Aquini <aquini@redhat.com>

diff --git a/drivers/infiniband/hw/mlx5/mad.c b/drivers/infiniband/hw/mlx5/mad.c
index 1534af1..364aab9 100644
--- a/drivers/infiniband/hw/mlx5/mad.c
+++ b/drivers/infiniband/hw/mlx5/mad.c
@@ -121,7 +121,7 @@ static void pma_cnt_ext_assign(struct ib_pma_portcounters_ext *pma_cnt_ext,
  pma_cnt_ext->port_xmit_data =
   cpu_to_be64(MLX5_SUM_CNT(out, transmitted_ib_unicast.octets,
       transmitted_ib_multicast.octets) >> 2);
- pma_cnt_ext->port_xmit_data =
+ pma_cnt_ext->port_rcv_data =
   cpu_to_be64(MLX5_SUM_CNT(out, received_ib_unicast.octets,
       received_ib_multicast.octets) >> 2);
  pma_cnt_ext->port_xmit_packets =
-- 
1.7.1