From a8a1c6db6638322ecefce6a57d35838c1ee5311b Mon Sep 17 00:00:00 2001
From: David Gibson <dgibson@redhat.com>
Date: Wed, 14 Sep 2016 06:19:25 -0400
Subject: [powerpc] kvm: book3s: Don't crash if irqfd used with no in-kernel XICS emulation

Message-id: <1473833966-25009-2-git-send-email-dgibson@redhat.com>
Patchwork-id: 157811
O-Subject: [RHEL-7.3 kernel PATCH 1/2] KVM: PPC: Book3S: Don't crash if irqfd used with no in-kernel XICS emulation
Bugzilla: 1375778
RH-Acked-by: Don Zickus <dzickus@redhat.com>
RH-Acked-by: Laurent Vivier <lvivier@redhat.com>
RH-Acked-by: Thomas Huth <thuth@redhat.com>

From: Paul Mackerras <paulus@ozlabs.org>

It turns out that if userspace creates a pseries-type VM without
in-kernel XICS (interrupt controller) emulation, and then connects
an eventfd to the VM as an irqfd, and the eventfd gets signalled,
that the code will try to deliver an interrupt via the non-existent
XICS object and crash the host kernel with a NULL pointer dereference.

To fix this, we check for the presence of the XICS object before
trying to deliver the interrupt, and return with an error if not.

Signed-off-by: Paul Mackerras <paulus@ozlabs.org>
(cherry picked from commit e48ba1cbce12eb4546771d45c09dd94c3404efe8)

Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1375778

Signed-off-by: David Gibson <dgibson@redhat.com>
Signed-off-by: Rafael Aquini <aquini@redhat.com>

diff --git a/arch/powerpc/kvm/book3s_xics.c b/arch/powerpc/kvm/book3s_xics.c
index b41f9ea..47695da 100644
--- a/arch/powerpc/kvm/book3s_xics.c
+++ b/arch/powerpc/kvm/book3s_xics.c
@@ -1252,6 +1252,8 @@ int kvm_set_irq(struct kvm *kvm, int irq_source_id, u32 irq, int level,
 {
  struct kvmppc_xics *xics = kvm->arch.xics;
 
+ if (!xics)
+  return -ENODEV;
  return ics_deliver_irq(xics, irq, level);
 }
 
-- 
1.7.1