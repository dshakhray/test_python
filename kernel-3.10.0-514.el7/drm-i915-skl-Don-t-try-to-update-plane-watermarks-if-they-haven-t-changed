From 0b824544779e72cec8a01bee383dd032b164c483 Mon Sep 17 00:00:00 2001
From: Lyude Paul <cpaul@redhat.com>
Date: Thu, 15 Sep 2016 17:56:50 -0400
Subject: [drm] i915/skl: Don't try to update plane watermarks if they haven't changed

Message-id: <1473962216-29060-10-git-send-email-cpaul@redhat.com>
Patchwork-id: 157888
O-Subject: [RHEL7.3][RESEND PATCH v2 09/15] drm/i915/skl: Don't try to update plane watermarks if they haven't changed
Bugzilla: 1341633 1355776
RH-Acked-by: Adam Jackson <ajax@redhat.com>
RH-Acked-by: Rob Clark <rclark@redhat.com>

From: Lyude Paul <cpaul@redhat.com>

Upstream: since drm-intel-next-2016-09-02-19-gccebc23

commit ccebc23b57c313229526dc76383ce82f5e0b9001

Author: Lyude <cpaul@redhat.com>
Date:   Mon Aug 29 12:31:27 2016 -0400

    drm/i915/skl: Don't try to update plane watermarks if they haven't changed

    i915 sometimes needs to disable planes in the middle of an atomic
    commit, and then reenable them later in the same commit. Because of
    this, we can't make the assumption that the state of the plane actually
    changed. Since the state of the plane hasn't actually changed, neither
    have it's watermarks. And if the watermarks hasn't changed then we
    haven't populated skl_results with anything, which means we'll end up
    zeroing out a plane's watermarks in the middle of the atomic commit
    without restoring them later.

    Simple reproduction recipe:
     - Get a SKL laptop, launch any kind of X session
     - Get two extra monitors
     - Keep hotplugging both displays (so that the display configuration
       jumps from 1 active pipe to 3 active pipes and back)
     - Eventually underrun

    Changes since v1:
     - Fix incorrect use of "it's"
    Changes since v2:
     - Add reproduction recipe

    Signed-off-by: Lyude <cpaul@redhat.com>
    Cc: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
    Fixes: 62e0fb880123 ("drm/i915/skl: Update plane watermarks atomically during plane updates")
    Signed-off-by: Lyude <cpaul@redhat.com>
    Testcase: kms_plane
    Signed-off-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1472488288-27280-1-git-send-email-cpaul@redhat.com
    Cc: drm-intel-fixes@lists.freedesktop.org

RHBZ: 1341633
RHBZ: 1355776
Signed-off-by: Lyude Paul <cpaul@redhat.com>
Signed-off-by: Lyude <cpaul@redhat.com>
Signed-off-by: Rafael Aquini <aquini@redhat.com>

diff --git a/drivers/gpu/drm/i915/intel_display.c b/drivers/gpu/drm/i915/intel_display.c
index fc831b4..460d1c5 100644
--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -3168,7 +3168,12 @@ static void skylake_disable_primary_plane(struct drm_plane *primary,
  struct intel_crtc *intel_crtc = to_intel_crtc(crtc);
  int pipe = intel_crtc->pipe;
 
- skl_write_plane_wm(intel_crtc, &dev_priv->wm.skl_results, 0);
+ /*
+  * We only populate skl_results on watermark updates, and if the
+  * plane's visiblity isn't actually changing neither is its watermarks.
+  */
+ if (!to_intel_plane_state(crtc->primary->state)->visible)
+  skl_write_plane_wm(intel_crtc, &dev_priv->wm.skl_results, 0);
 
  I915_WRITE(PLANE_CTL(pipe, 0), 0);
  I915_WRITE(PLANE_SURF(pipe, 0), 0);
diff --git a/drivers/gpu/drm/i915/intel_sprite.c b/drivers/gpu/drm/i915/intel_sprite.c
index 00ac91b..0570ae7 100644
--- a/drivers/gpu/drm/i915/intel_sprite.c
+++ b/drivers/gpu/drm/i915/intel_sprite.c
@@ -298,8 +298,13 @@ skl_disable_plane(struct drm_plane *dplane, struct drm_crtc *crtc)
  const int pipe = intel_plane->pipe;
  const int plane = intel_plane->plane + 1;
 
- skl_write_plane_wm(to_intel_crtc(crtc), &dev_priv->wm.skl_results,
-      plane);
+ /*
+  * We only populate skl_results on watermark updates, and if the
+  * plane's visiblity isn't actually changing neither is its watermarks.
+  */
+ if (!to_intel_plane_state(dplane->state)->visible)
+  skl_write_plane_wm(to_intel_crtc(crtc),
+       &dev_priv->wm.skl_results, plane);
 
  I915_WRITE(PLANE_CTL(pipe, plane), 0);
 
-- 
1.7.1