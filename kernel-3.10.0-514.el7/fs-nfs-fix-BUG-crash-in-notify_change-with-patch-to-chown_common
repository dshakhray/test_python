From ad2b5553bce796bb436341f95878f426b496dd3f Mon Sep 17 00:00:00 2001
From: J. Bruce Fields <bfields@redhat.com>
Date: Fri, 9 Sep 2016 20:40:41 -0400
Subject: [fs] nfs: fix BUG() crash in notify_change() with patch to chown_common()

Message-id: <1473453641-4490-1-git-send-email-bfields@redhat.com>
Patchwork-id: 157750
O-Subject: [Patch RHEL7 fs] NFS: fix BUG() crash in notify_change() with patch to chown_common()
Bugzilla: 1342695
RH-Acked-by: Jeff Layton <jlayton@redhat.com>
RH-Acked-by: Steve Dickson <SteveD@redhat.com>
RH-Acked-by: Jarod Wilson <jarod@redhat.com>

From: Andrew Elble <aweits@rit.edu>

We have observed a BUG() crash in fs/attr.c:notify_change(). The crash
occurs during an rsync into a filesystem that is exported via NFS.

1.) fs/attr.c:notify_change() modifies the caller's version of attr.
2.) 6de0ec00ba8d ("VFS: make notify_change pass ATTR_KILL_S*ID to
    setattr operations") introduced a BUG() restriction such that "no
    function will ever call notify_change() with both ATTR_MODE and
    ATTR_KILL_S*ID set". Under some circumstances though, it will have
    assisted in setting the caller's version of attr to this very
    combination.
3.) 27ac0ffeac80 ("locks: break delegations on any attribute
    modification") introduced code to handle breaking
    delegations. This can result in notify_change() being re-called. attr
    _must_ be explicitly reset to avoid triggering the BUG() established
    in #2.
4.) The path that that triggers this is via fs/open.c:chmod_common().
    The combination of attr flags set here and in the first call to
    notify_change() along with a later failed break_deleg_wait()
    results in notify_change() being called again via retry_deleg
    without resetting attr.

Solution is to move retry_deleg in chmod_common() a bit further up to
ensure attr is completely reset.

There are other places where this seemingly could occur, such as
fs/utimes.c:utimes_common(), but the attr flags are not initially
set in such a way to trigger this.

Fixes: 27ac0ffeac80 ("locks: break delegations on any attribute modification")
Reported-by: Eric Meddaugh <etmsys@rit.edu>
Tested-by: Eric Meddaugh <etmsys@rit.edu>
Signed-off-by: Andrew Elble <aweits@rit.edu>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Upstream: c1b8940b42bb6487b10f2267a96b486276ce9ff7
Bugzilla: 1342695
Signed-off-by: Rafael Aquini <aquini@redhat.com>

diff --git a/fs/open.c b/fs/open.c
index abeeca9..7cf04f9 100644
--- a/fs/open.c
+++ b/fs/open.c
@@ -565,6 +565,7 @@ static int chown_common(struct path *path, uid_t user, gid_t group)
  uid = make_kuid(current_user_ns(), user);
  gid = make_kgid(current_user_ns(), group);
 
+retry_deleg:
  newattrs.ia_valid =  ATTR_CTIME;
  if (user != (uid_t) -1) {
   if (!uid_valid(uid))
@@ -581,7 +582,6 @@ static int chown_common(struct path *path, uid_t user, gid_t group)
  if (!S_ISDIR(inode->i_mode))
   newattrs.ia_valid |=
    ATTR_KILL_SUID | ATTR_KILL_SGID | ATTR_KILL_PRIV;
-retry_deleg:
  mutex_lock(&inode->i_mutex);
  error = security_path_chown(path, uid, gid);
  if (!error)
-- 
1.7.1