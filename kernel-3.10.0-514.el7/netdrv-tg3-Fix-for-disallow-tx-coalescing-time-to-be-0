From 5de1318bb0c01795707fa9dd941fb11bcfc3abb4 Mon Sep 17 00:00:00 2001
From: Ivan Vecera <ivecera@redhat.com>
Date: Thu, 15 Sep 2016 12:06:17 -0400
Subject: [netdrv] tg3: Fix for disallow tx coalescing time to be 0

Message-id: <1473941177-29986-3-git-send-email-ivecera@redhat.com>
Patchwork-id: 157838
O-Subject: [RHEL7.3 PATCH 2/2] tg3: Fix for disallow tx coalescing time to be 0
Bugzilla: 1368885
RH-Acked-by: Jarod Wilson <jarod@redhat.com>
RH-Acked-by: John Linville <linville@redhat.com>
RH-Acked-by: Stefan Assmann <sassmann@redhat.com>
RH-Acked-by: David S. Miller <davem@redhat.com>

BZ#1368885

Upstream commit(s):
commit aabdd09d535073c35f746e46c3a5d3286088be3a
Author: Ivan Vecera <ivecera@redhat.com>
Date:   Thu Sep 1 11:28:59 2016 +0200

    tg3: Fix for disallow tx coalescing time to be 0

    The recent commit 087d7a8c9174 "tg3: Fix for diasllow rx coalescing
    time to be 0" disallow to set Rx coalescing time to be 0 as this stops
    generating interrupts for the incoming packets. I found the zero
    Tx coalescing time stops generating interrupts for outgoing packets
    as well and fires Tx watchdog later. To avoid this, don't allow to set
    Tx coalescing time to 0 and also remove subsequent checks that become
    senseless.

    Cc: satish.baddipadige@broadcom.com
    Cc: siva.kallam@broadcom.com
    Cc: michael.chan@broadcom.com
    Signed-off-by: Ivan Vecera <ivecera@redhat.com>
    Acked-by: Siva Reddy Kallam <siva.kallam@broadcom.com>
    Acked-by: Michael Chan <michael.chan@broadcom.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

Signed-off-by: Ivan Vecera <ivecera@redhat.com>
Signed-off-by: Rafael Aquini <aquini@redhat.com>

diff --git a/drivers/net/ethernet/broadcom/tg3.c b/drivers/net/ethernet/broadcom/tg3.c
index 50649e5..7ba1c1f 100644
--- a/drivers/net/ethernet/broadcom/tg3.c
+++ b/drivers/net/ethernet/broadcom/tg3.c
@@ -14017,6 +14017,7 @@ static int tg3_set_coalesce(struct net_device *dev, struct ethtool_coalesce *ec)
  if ((ec->rx_coalesce_usecs > MAX_RXCOL_TICKS) ||
      (!ec->rx_coalesce_usecs) ||
      (ec->tx_coalesce_usecs > MAX_TXCOL_TICKS) ||
+     (!ec->tx_coalesce_usecs) ||
      (ec->rx_max_coalesced_frames > MAX_RXMAX_FRAMES) ||
      (ec->tx_max_coalesced_frames > MAX_TXMAX_FRAMES) ||
      (ec->rx_coalesce_usecs_irq > max_rxcoal_tick_int) ||
@@ -14027,16 +14028,6 @@ static int tg3_set_coalesce(struct net_device *dev, struct ethtool_coalesce *ec)
      (ec->stats_block_coalesce_usecs < min_stat_coal_ticks))
   return -EINVAL;
 
- /* No rx interrupts will be generated if both are zero */
- if ((ec->rx_coalesce_usecs == 0) &&
-     (ec->rx_max_coalesced_frames == 0))
-  return -EINVAL;
-
- /* No tx interrupts will be generated if both are zero */
- if ((ec->tx_coalesce_usecs == 0) &&
-     (ec->tx_max_coalesced_frames == 0))
-  return -EINVAL;
-
  /* Only copy relevant parameters, ignore all others. */
  tp->coal.rx_coalesce_usecs = ec->rx_coalesce_usecs;
  tp->coal.tx_coalesce_usecs = ec->tx_coalesce_usecs;
-- 
1.7.1