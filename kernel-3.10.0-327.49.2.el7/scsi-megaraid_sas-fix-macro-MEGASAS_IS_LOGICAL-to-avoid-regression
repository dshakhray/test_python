From 90f929a49f98bbb1006c06522253335a4816621c Mon Sep 17 00:00:00 2001
From: Tomas Henzl <thenzl@redhat.com>
Date: Wed, 30 Nov 2016 15:35:22 +0100
Subject: [scsi] megaraid_sas: fix macro MEGASAS_IS_LOGICAL to avoid regression

Message-id: <1480520125-10748-2-git-send-email-thenzl@redhat.com>
Patchwork-id: 160938
O-Subject: [RHEL7.2.z e-stor PATCH 1/4] [scsi] megaraid_sas: fix macro MEGASAS_IS_LOGICAL to avoid regression
Bugzilla: 1380447
Z-Bugzilla: 1398178
RH-Acked-by: David Milburn <dmilburn@redhat.com>
RH-Acked-by: Maurizio Lombardi <mlombard@redhat.com>
RH-Acked-by: Jeremy McNicoll <jmcnicol@redhat.com>

This patch will fix regression caused by commit 1e793f6fc0db ("scsi:
megaraid_sas: Fix data integrity failure for JBOD (passthrough)
devices").

The problem was that the MEGASAS_IS_LOGICAL macro did not have braces
and as a result the driver ended up exposing a lot of non-existing SCSI
devices (all SCSI commands to channels 1,2,3 were returned as
SUCCESS-DID_OK by driver).

[mkp: clarified patch description]

Fixes: 1e793f6fc0db920400574211c48f9157a37e3945
[tomash: (RH specific) - moved the fix before the regression causing patch]

Reported-by: Jens Axboe <axboe@kernel.dk>
CC: stable@vger.kernel.org
Signed-off-by: Kashyap Desai <kashyap.desai@broadcom.com>
Signed-off-by: Sumit Saxena <sumit.saxena@broadcom.com>
Tested-by: Sumit Saxena <sumit.saxena@broadcom.com>
Reviewed-by: Tomas Henzl <thenzl@redhat.com>
Tested-by: Jens Axboe <axboe@fb.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 5e5ec1759dd663a1d5a2f10930224dd009e500e8)
Signed-off-by: Rafael Aquini <aquini@redhat.com>
(cherry picked from commit 20936a1fab1819024c8a32a88e9c805b5b9337b2)
---
 drivers/scsi/megaraid/megaraid_sas.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/drivers/scsi/megaraid/megaraid_sas.h b/drivers/scsi/megaraid/megaraid_sas.h
index 8d75799..8b7c678 100644
--- a/drivers/scsi/megaraid/megaraid_sas.h
+++ b/drivers/scsi/megaraid/megaraid_sas.h
@@ -1875,7 +1875,7 @@ struct megasas_instance_template {
 };
 
 #define MEGASAS_IS_LOGICAL(scp)      \
- (scp->device->channel < MEGASAS_MAX_PD_CHANNELS) ? 0 : 1
+ ((scp->device->channel < MEGASAS_MAX_PD_CHANNELS) ? 0 : 1)
 
 #define MEGASAS_DEV_INDEX(scp)      \
  (((scp->device->channel % 2) * MEGASAS_MAX_DEV_PER_CHANNEL) + \
-- 
1.7.1