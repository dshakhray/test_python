From 817bf2305627a13f6aa5919adb9ba50cddb53ab7 Mon Sep 17 00:00:00 2001
From: Alexander Gordeev <agordeev@redhat.com>
Date: Mon, 28 Nov 2016 08:32:48 +0100
Subject: [scsi] mpt3sas: Fix panic when aer correct error occurred

Message-id: <20161128083248.GA29569@localhost>
Patchwork-id: 160917
O-Subject: [PATCH RHEL7.2.z BZ1395220] mpt3sas: Fix panic when aer correct error occurred
Bugzilla: 1374745
Z-Bugzilla: 1395220
RH-Acked-by: David Milburn <dmilburn@redhat.com>

This is a trivial fuzz fixup to apply 7.4 commit d13119a5
to 7.2.z

Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1395220
Scratch:  https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=12152379

SGI urgently needs this patch in RHEL 7.3.  Prarit has flipped several of the
flags on the BZ and we are working on getting the rest of the
needed approvals.

commit: 83c3d3400c87d6d943bf97fce4b30f4fe6870253
Author: Kefeng Wang <wangkefeng.wang@huawei.com>
Date: 2016-07-12 09:43:25 (GMT)

The _scsih_pci_mmio_enabled called if scsih_pci_error_detected returns
PCI_ERS_RESULT_CAN_RECOVER, at this point, read/write to the device
still works, no need to reset slot.

Or the mpt3sas_base_map_resources in scsih_pci_slot_reset will fail,
and iounamp ioc->chip, then we will meet issue when read ioc->chip
in mpt3sas_base_get_iocstate from _base_fault_reset_work.

 Cc: Sathya Prakash <sathya.prakash@broadcom.com>
 Cc: Chaitra P B <chaitra.basappa@broadcom.com>
 Cc: Suganath Prabu Subramani <suganath-prabu.subramani@broadcom.com>
 Signed-off-by: Kefeng Wang <wangkefeng.wang@huawei.com>
 Acked-by: Chaitra P B <chaitra.basappa@broadcom.com>
 Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Alexander Gordeev <agordeev@redhat.com>
---
 drivers/scsi/mpt3sas/mpt3sas_scsih.c |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/drivers/scsi/mpt3sas/mpt3sas_scsih.c b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
index 3f8680c..b001124 100644
--- a/drivers/scsi/mpt3sas/mpt3sas_scsih.c
+++ b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
@@ -8124,8 +8124,11 @@ _scsih_pci_mmio_enabled(struct pci_dev *pdev)
 
  /* TODO - dump whatever for debugging purposes */
 
- /* Request a slot reset. */
- return PCI_ERS_RESULT_NEED_RESET;
+ /* This called only if scsih_pci_error_detected returns
+  * PCI_ERS_RESULT_CAN_RECOVER. Read/write to the device still
+  * works, no need to reset slot.
+  */
+ return PCI_ERS_RESULT_RECOVERED;
 }
 
 /* raid transport support */
-- 
1.7.1