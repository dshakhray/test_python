From 35a32b10af796e484b82fb8d561b831956e2d8f1 Mon Sep 17 00:00:00 2001
From: Tomas Henzl <thenzl@redhat.com>
Date: Mon, 12 Sep 2016 13:05:42 +0200
Subject: [scsi] mpt3sas: Fix use sas_is_tlr_enabled API before enabling MPI2_SCSIIO_CONTROL_TLR_ON flag

Message-id: <1473685543-5362-2-git-send-email-thenzl@redhat.com>
Patchwork-id: 157755
O-Subject: [RHEL7.2.z PATCH e-stor 1/2] mpt3sas: Fix use sas_is_tlr_enabled API before enabling MPI2_SCSIIO_CONTROL_TLR_ON flag
Bugzilla: 1262031
Z-Bugzilla: 1371462
RH-Acked-by: Ewan Milne <emilne@redhat.com>

Before enabling MPI2_SCSIIO_CONTROL_TLR_ON flag in MPI SCSI IO request
message, check whether TLR is enabled on the drive using
'sas_is_tlr_enabled' API.

Actually in the driver code, driver is using below API's

1. sas_enable_tlr() - to enable the TLR
2. sas_disable_tlr() - to disable the TLR
3. sas_is_tlr_enabled() - to check whether TLR is enabled or not.

but in scsih_qcmd() we have missed to use sas_is_tlr_enabled() API,
instead we checking for TLR bit from flag field of driver's 'struct
MPT3SAS_DEVIC' structure. which is corrected with this patch.

Adapted from 15de0de29f7ba5cce9699a8cc2344ca137beb25a

Signed-off-by: Sreekanth Reddy <Sreekanth.Reddy@avagotech.com>
Reviewed-by: Hannes Reinecke <hare@suse.de>
Reviewed-by: Tomas Henzl <thenzl@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/drivers/scsi/mpt3sas/mpt3sas_scsih.c b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
index 1ea4760..cfb1345 100644
--- a/drivers/scsi/mpt3sas/mpt3sas_scsih.c
+++ b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
@@ -3637,8 +3637,7 @@ _scsih_qcmd(struct Scsi_Host *shost, struct scsi_cmnd *scmd)
  } else
   mpi_control |= MPI2_SCSIIO_CONTROL_SIMPLEQ;
 
- if ((sas_device_priv_data->flags & MPT_DEVICE_TLR_ON) &&
-     scmd->cmd_len != 32)
+ if (sas_is_tlr_enabled(scmd->device) &&  scmd->cmd_len != 32)
   mpi_control |= MPI2_SCSIIO_CONTROL_TLR_ON;
 
  smid = mpt3sas_base_get_smid_scsiio(ioc, ioc->scsi_io_cb_idx, scmd);
-- 
1.7.1