From fa6966c5dacec576782a7381805970bc851e0d48 Mon Sep 17 00:00:00 2001
From: David Milburn <dmilburn@redhat.com>
Date: Thu, 12 Nov 2015 18:23:30 +0100
Subject: [block] nvme: Fix filesystem deadlock on removal

Message-id: <1447352610-35633-1-git-send-email-dmilburn@redhat.com>
Patchwork-id: 126635
O-Subject: [RHEL7.3 PATCH] NVMe: Fix filesystem deadlock on removal
Bugzilla: 1279699
Z-Bugzilla: 1365631
RH-Acked-by: Jes Sorensen <Jes.Sorensen@redhat.com>
RH-Acked-by: Corinna Vinschen <vinschen@redhat.com>
RH-Acked-by: Jarod Wilson <jarod@redhat.com>
RH-Acked-by: Steve Best <sbest@redhat.com>

From: Keith Busch <keith.busch@intel.com>

Under heavy load, reporter saw deadlock when removing NVMe SSD. Patched
kernel has been verified, this resolves BZ 1279699.

https://brewweb.devel.redhat.com/taskinfo?taskID=10093329

Fix has been requested for 7.2 Z-stream, please review and ACK.

Move gendisk deletion before controller shutdown so filesystem may sync
dirty pages. Before, this would deadlock trying to allocate requests
on frozen queues that are about to be deleted.

Signed-off-by: Keith Busch <keith.busch@intel.com>
Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit 3399a3f7464a624db1b365dbce0fef0ef4636c05)

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/drivers/block/nvme-core.c b/drivers/block/nvme-core.c
index 66ce2c8..7711bc8 100644
--- a/drivers/block/nvme-core.c
+++ b/drivers/block/nvme-core.c
@@ -3121,8 +3121,8 @@ static void nvme_remove(struct pci_dev *pdev)
  flush_work(&dev->reset_work);
  flush_work(&dev->scan_work);
  device_remove_file(dev->device, &dev_attr_reset_controller);
- nvme_dev_shutdown(dev);
  nvme_dev_remove(dev);
+ nvme_dev_shutdown(dev);
  nvme_dev_remove_admin(dev);
  device_destroy(nvme_class, MKDEV(nvme_char_major, dev->instance));
  nvme_free_queues(dev, 0);
-- 
1.7.1