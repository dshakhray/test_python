From 71500952ac4385fe4a781cacb574fd71a076ebbd Mon Sep 17 00:00:00 2001
From: Eric Sandeen <sandeen@redhat.com>
Date: Fri, 10 Jun 2016 03:50:28 +0200
Subject: [fs] xfs: disallow rw remount on fs with unknown ro-compat features

Message-id: <5751b4d5-4fa9-a216-0bd5-acd8d3fede6b@redhat.com>
Patchwork-id: 150149
O-Subject: [PATCH RHEL7] xfs: disallow rw remount on fs with unknown ro-compat features
Bugzilla: 1321747
Z-Bugzilla: 1370144
RH-Acked-by: Jarod Wilson <jarod@redhat.com>
RH-Acked-by: Jes Sorensen <Jes.Sorensen@redhat.com>
RH-Acked-by: Brian Foster <bfoster@redhat.com>

Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1321747
Testing: Locally
Build: Local (trivial patch (tm))

Pushing this to RHEL7.3 mostly so we can consider it for older
RHEL zstreams for kernels which exist and don't know about
the finobt ro-compat feature present in newer kernels...

Upstream:

commit d0a58e833931234c44e515b5b8bede32bd4e6eed
Author: Eric Sandeen <sandeen@redhat.com>
Date:   Wed Apr 6 07:05:41 2016 +1000

    xfs: disallow rw remount on fs with unknown ro-compat features

    Today, a kernel which refuses to mount a filesystem read-write
    due to unknown ro-compat features can still transition to read-write
    via the remount path.  The old kernel is most likely none the wiser,
    because it's unaware of the new feature, and isn't using it.  However,
    writing to the filesystem may well corrupt metadata related to that
    new feature, and moving to a newer kernel which understand the feature
    will have problems.

    Right now the only ro-compat feature we have is the free inode btree,
    which showed up in v3.16.  It would be good to push this back to
    all the active stable kernels, I think, so that if anyone is using
    newer mkfs (which enables the finobt feature) with older kernel
    releases, they'll be protected.

    Cc: <stable@vger.kernel.org> # 3.10.x-
    Signed-off-by: Eric Sandeen <sandeen@redhat.com>
    Reviewed-by: Bill O'Donnell <billodo@redhat.com>
    Reviewed-by: Dave Chinner <dchinner@redhat.com>
    Signed-off-by: Dave Chinner <david@fromorbit.com>
---

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/fs/xfs/xfs_super.c b/fs/xfs/xfs_super.c
index 29c4130..c32ab51 100644
--- a/fs/xfs/xfs_super.c
+++ b/fs/xfs/xfs_super.c
@@ -1256,6 +1256,16 @@ xfs_fs_remount(
    return -EINVAL;
   }
 
+  if (XFS_SB_VERSION_NUM(sbp) == XFS_SB_VERSION_5 &&
+      xfs_sb_has_ro_compat_feature(sbp,
+     XFS_SB_FEAT_RO_COMPAT_UNKNOWN)) {
+   xfs_warn(mp,
+"ro->rw transition prohibited on unknown (0x%x) ro-compat filesystem",
+    (sbp->sb_features_ro_compat &
+     XFS_SB_FEAT_RO_COMPAT_UNKNOWN));
+   return -EINVAL;
+  }
+
   mp->m_flags &= ~XFS_MOUNT_RDONLY;
 
   /*
-- 
1.7.1