From 6e3e6a1aff5d9651f6c36b497bb55d22fe75f1dc Mon Sep 17 00:00:00 2001
From: Stanislav Kozina <skozina@redhat.com>
Date: Thu, 15 Sep 2016 11:49:22 +0200
Subject: [redhat] spec: declare kmod package conflicting dependency

Message-id: <1473940162-10113-1-git-send-email-skozina@redhat.com>
Patchwork-id: 157834
O-Subject: [RHEL-7.2.z PATCH] [redhat] spec: declare kmod package conflicting dependency
Bugzilla: 1373905
Z-Bugzilla: 1375937
RH-Acked-by: Alexander Gordeev <agordeev@redhat.com>

This is a backport of rhel-7.3 commit 036fed7 ([redhat] spec: declare kmod
package conflicting dependency).

Bugzilla: 1375937
Brew: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=11757523

Testing: Kernel installed in a vm running rhel-7.2.

commit 036fed7028b5f5a54daf0e8f98bfa7aac6b9025c
Author: Stanislav Kozina <skozina@redhat.com>
Date:   Fri Sep 9 13:08:54 2016 -0400

    [redhat] spec: declare kmod package conflicting dependency

    Message-id: <1473426534-16236-1-git-send-email-skozina@redhat.com>
    Patchwork-id: 157742
    O-Subject: [RHEL-7.3 PATCH v2] spec: Add require dependency on kmod package
    Bugzilla: 1373905
    RH-Acked-by: Jarod Wilson <jarod@redhat.com>
    RH-Acked-by: Rafael Aquini <aquini@redhat.com>

    Bugzilla: 1373905
    Brew: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=11726343
    Upstream: internal only

    The kernel installation calls /sbin/weak-modules in order to create a symlink
    in /usr/lib/modules/$(uname -r)/weak-modules for previously installed external
    drivers (such as those released through the Driver Update Program).
    This patch introduced a dependency on an updated version of the kmod package
    which contains fix to the /sbin/weak-modules script..
    Tested by installing this kernel in a VM.

    Signed-off-by: Rafael Aquini <aquini@redhat.com>

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/redhat/kernel.spec.template b/redhat/kernel.spec.template
index 03d5955..134dd13 100644
--- a/redhat/kernel.spec.template
+++ b/redhat/kernel.spec.template
@@ -234,7 +234,7 @@ Summary: The Linux kernel
 # problems with the newer kernel or lack certain things that make
 # integration in the distro harder than needed.
 #
-%define package_conflicts initscripts < 7.23, udev < 063-6, iptables < 1.3.2-1, ipw2200-firmware < 2.4, iwl4965-firmware < 228.57.2, selinux-policy-targeted < 1.25.3-14, squashfs-tools < 4.0, wireless-tools < 29-3
+%define package_conflicts initscripts < 7.23, udev < 063-6, iptables < 1.3.2-1, ipw2200-firmware < 2.4, iwl4965-firmware < 228.57.2, selinux-policy-targeted < 1.25.3-14, squashfs-tools < 4.0, wireless-tools < 29-3, kmod < 20-8
 
 # We moved the drm include files into kernel-headers, make sure there's
 # a recent enough libdrm-devel on the system that doesn't have those.
-- 
1.7.1