From 78ea39deebd59ab8e923dd4dad9179eb84a9cf5e Mon Sep 17 00:00:00 2001
From: Michael S. Tsirkin <mst@redhat.com>
Date: Sun, 8 May 2016 14:39:06 +0200
Subject: [virtio] virtio-pci: use possible fallback queue size

Message-id: <1462718132-2070-1-git-send-email-mst@redhat.com>
Patchwork-id: 143618
O-Subject: [PATCH RHEL7.3/7.2.z] virtio-pci: use possible fallback queue size
Bugzilla: 1320152
Z-Bugzilla: 1370171
RH-Acked-by: Ladi Prosek <lprosek@redhat.com>
RH-Acked-by: Thomas Huth <thuth@redhat.com>
RH-Acked-by: Jason Wang <jasowang@redhat.com>

From: Liang Chen <liangchen.linux@gmail.com>

Virtio 1.0 spec allows driver to modify queue size to reduce memory
requirements. So the driver should write back the queue size actually
allocated, instead of the original value read from the common config
for the queue.

Signed-off-by: Liang Chen <liangchen.linux@gmail.com>
Signed-off-by: Gavin Guo <gavin.guo@canonical.com>
Suggested-by: Jay Vosburgh <jay.vosburgh@canonical.com>

Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1320152
Tested: lightly on developer's system
Brew build: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=10983886
Upstream: N/A superceded by commit 7a5589b240b405d55b2b395554082ec284f414bb
 "virtio_pci: Use the DMA API if enabled".

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/drivers/virtio/virtio_pci_modern.c b/drivers/virtio/virtio_pci_modern.c
index e88e099..f7f60d5 100644
--- a/drivers/virtio/virtio_pci_modern.c
+++ b/drivers/virtio/virtio_pci_modern.c
@@ -360,7 +360,7 @@ static struct virtqueue *setup_vq(struct virtio_pci_device *vp_dev,
  }
 
  /* activate the queue */
- vp_iowrite16(num, &cfg->queue_size);
+ vp_iowrite16(info->num, &cfg->queue_size);
  vp_iowrite64_twopart(virt_to_phys(info->queue),
         &cfg->queue_desc_lo, &cfg->queue_desc_hi);
  vp_iowrite64_twopart(virt_to_phys(virtqueue_get_avail(vq)),
-- 
1.7.1