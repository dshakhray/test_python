From f816df0d249ba53015a27f92c4563344e3817dbb Mon Sep 17 00:00:00 2001
From: Peter Xu <peterx@redhat.com>
Date: Fri, 20 Nov 2015 02:34:34 +0100
Subject: [x86] pvpanic: Set high notifier priority

Message-id: <1447986874-17144-1-git-send-email-peterx@redhat.com>
Patchwork-id: 127274
O-Subject: [RHEL7.3 PATCH v2] pvpanic: Set high notifier priority
Bugzilla: 1282794
Z-Bugzilla: 1370179
RH-Acked-by: Bandan Das <bsd@redhat.com>
RH-Acked-by: Jarod Wilson <jarod@redhat.com>

From: Takashi Iwai <tiwai@suse.de>

BZ: https://bugzilla.redhat.com/show_bug.cgi?id=1282794
UPSTREAM: 7939831eacd81fccbd7a956b30c7bb3abb9079db
BREW: https://brewweb.devel.redhat.com/taskinfo?taskID=10124188
TEST: enabled pvpanic device in guest, when panic triggered in guest,
should see libvirt automatically reboot the system, rather than guest
panic and hang.

This is a one-line backport from upstream that work around the
issue for missing pvpanic device notification in guest.

Original message:

We've observed the missing pvpanic call at panic, and it turned out
that this was blocked by the broken notifier of drm_fb_helper, where
scheduling may be called during switching to the fb console.
It's fairly difficult to fix the drm_fb problem and a quick fix isn't
foreseen, a simpler solution for the missing pvpanic call would be
just to call this earlier.

In order to assure that, this patch sets a higher priority to pvpanic
notifier_block.  Once when the issue of drm_fb is resolved, we can
remove this priority again.

Signed-off-by: Takashi Iwai <tiwai@suse.de>
Signed-off-by: Matthew Garrett <matthew.garrett@nebula.com>
(cherry picked from commit 7939831eacd81fccbd7a956b30c7bb3abb9079db)
Signed-off-by: Peter Xu <peterx@redhat.com>

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>

diff --git a/drivers/platform/x86/pvpanic.c b/drivers/platform/x86/pvpanic.c
index 47ae0c4..469e182 100644
--- a/drivers/platform/x86/pvpanic.c
+++ b/drivers/platform/x86/pvpanic.c
@@ -71,6 +71,7 @@ pvpanic_panic_notify(struct notifier_block *nb, unsigned long code,
 
 static struct notifier_block pvpanic_panic_nb = {
  .notifier_call = pvpanic_panic_notify,
+ .priority = 1, /* let this called before broken drm_fb_helper */
 };
 
 
-- 
1.7.1